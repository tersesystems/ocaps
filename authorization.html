<!DOCTYPE html>
<html class="no-js" lang="eng" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authorizing Capabilities</title>
    <link rel="stylesheet" href="theme/css/foundation.min.css">
    <link rel="stylesheet" href="theme/css/app.css">
    
     <link rel="stylesheet" href="theme/highlight.js/styles/github-gist.css">  <link rel="stylesheet" href="theme/css/foundation-icons.custom.css"> 
    
     <link rel="prev" href="management.html"  title="Managing Capabilities"  />  <link rel="next" href="confinement.html"  title="Confining Capabilities"  />  <link rel="start" href="index.html"  title="Introduction"  />  <link rel="toc" href="site-contents.html"  title="Table of Contents"  /> 
  </head>
  <body>
    <div class="expanded row">
      <div class="small-12 medium-12 large-12 columns align-self-top">
        <div class="row">
          
          <header class="large-12 columns align-self-top a_header">
            <div class="row">
              <div class="large-12 columns a_limited top-bar">
                <div class="top-bar-left">
                  <p>ocaps Manual</p>

                </div>
                <div class="top-bar-right align-right row">
                  
                  
                    <form action="site-search.html" method="get" class="align-right a_search">
                      <input name="q" type="search"  placeholder="Search
" >
                      <button><img alt="&#1F50D;" src="theme/images/search.svg" /></button>
                    </form>
                  
                </div>
              </div>
            </div>
          </header>
          
          <div class="small-12 medium-12 large-12 columns align-self-top a_limited a_main">
            <div class="row">
              
              <main class="columns large-order-2 sections" id="_sections">
                 
  <ul class="menu align-right simple a_navbar a_navbar_top">
    
      
        <li><a href="management.html"  title="Managing Capabilities" ><span class="a_foundation_icon"></span>  Previous</a></li>
      
    
      
        <li><a href="confinement.html"  title="Confining Capabilities" ><span class="a_foundation_icon"></span>  Next</a></li>
      
    
      
        <li><a href="site-contents.html"  title="Table of Contents" ><span class="a_foundation_icon"></span>  Contents</a></li>
      
    
  </ul>
 
                
                <h1 id="authorizing-capabilities" class="a_section" data-magellan-target="authorizing-capabilities">Authorizing Capabilities<a class="a_hlink" href="#authorizing-capabilities"></a></h1>
<h2 id="a-brief-history-of-authorization" class="a_section" data-magellan-target="a-brief-history-of-authorization">A Brief History of Authorization<a class="a_hlink" href="#a-brief-history-of-authorization"></a></h2>
<p>TODO</p>
<h2 id="authorizating-capabilities-with-gatekeeper" class="a_section" data-magellan-target="authorizating-capabilities-with-gatekeeper">Authorizating Capabilities with Gatekeeper<a class="a_hlink" href="#authorizating-capabilities-with-gatekeeper"></a></h2>
<p>Handing out a capability to an object gives the object authority over the resource.  The question of whether that object should have authority or not is an authorization decision.  The question of authorization (“what authority”) is usually accompanied by the question of authentication (“who should have this authority?”).</p>
<p>In capability based systems, there are four stages before a capability is handed out.  <a href="https://youtu.be/XQWY9_BcSGI?t=8m40s">Alan Karp</a> defines four stages:</p>
<ol>
<li>Identification (grant privs)</li>
<li>Authentication (let a process running on behalf use priv associated with identity)</li>
<li>Authorization (grant token, etc)</li>
<li>Access Decision (in the service )</li>
</ol>
<p>Capability-based authorization systems identify a policy that says who is authorized for an operation on a resource, and then hand out a capability for that operation.  That capability is then used directly.  This is in contrast to role based access control (RBAC), which ties in the identity directly.  Examples include <a href="https://en.wikipedia.org/wiki/OAuth#OAuth_2.0">OAuth 2 Bearer Token</a> and <a href="https://en.wikipedia.org/wiki/XACML">XACML</a>, but it’s quite simple to create your own.</p>
<p>This may not mean much in isolation, so let’s run through an example with Scala code, implementing a Gatekeeper class for documents.</p>
<p>First, we need authentication.  Let’s posit a <code class="hljs">User</code> class that serves as the <a href="https://stackoverflow.com/a/5025140">principal</a>, and an implicit <code class="hljs">SecurityContext</code> that serves as an <a href="http://www.lihaoyi.com/post/ImplicitDesignPatternsinScala.html#implicit-contexts">implicit context</a>.</p>
<div class="row"><div class="a_linked small-expand columns a_xscroll a_codeblock">
<pre class="hljs"><code class="language-scala"><span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">name: <span class="hljs-type">String</span></span>)</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityContext</span>(<span class="hljs-params">val user: <span class="hljs-type">User</span></span>)</span>
</code></pre>
</div></div>
<p>We also need to extend <code class="hljs">Document</code> slightly to have an <code class="hljs">owner</code> field:</p>
<div class="row"><div class="a_linked small-expand columns a_xscroll a_codeblock">
<pre class="hljs"><code class="language-scala"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Document</span> <span class="hljs-title">private</span>(<span class="hljs-params">val owner: <span class="hljs-type">String</span>,
                             private[this] val path: <span class="hljs-type">Path</span></span>) </span>{
   ...
}
</code></pre>
</div></div>
<p>Next, we put together a <code class="hljs">DocumentGatekeeper</code>.  This takes a <code class="hljs">reader(doc: Document)</code> with the <code class="hljs">SecurityContext</code> as an implicit parameter, and returns the <code class="hljs">Document.Reader</code> capability only if it passes the document policy.</p>
<div class="row"><div class="a_linked small-expand columns a_xscroll a_codeblock">
<pre class="hljs"><code class="language-scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentGatekeeper</span>(<span class="hljs-params"></span>) </span>{

  <span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentPolicy</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">canRead</span></span>(user: <span class="hljs-type">User</span>, doc: <span class="hljs-type">Document</span>): <span class="hljs-type">Boolean</span> = {
      isDocumentOwner(user, doc) || isAdmin(user)
    }
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isDocumentOwner</span></span>(user: <span class="hljs-type">User</span>, doc: <span class="hljs-type">Document</span>): <span class="hljs-type">Boolean</span> = {
      doc.owner.equals(user.name) || isAdmin(user)
    }
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isAdmin</span></span>(user: <span class="hljs-type">User</span>): <span class="hljs-type">Boolean</span> = {
      user.name.equals(<span class="hljs-string">"admin"</span>)
    }
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> access = <span class="hljs-type">Document</span>.<span class="hljs-type">Access</span>()
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> policy = <span class="hljs-keyword">new</span> <span class="hljs-type">DocumentPolicy</span>
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reader</span></span>(doc: <span class="hljs-type">Document</span>)(<span class="hljs-keyword">implicit</span> ctx: <span class="hljs-type">SecurityContext</span>): <span class="hljs-type">Try</span>[<span class="hljs-type">Reader</span>] = {
    <span class="hljs-keyword">if</span> (policy.canRead(ctx.user, doc)) {
      <span class="hljs-type">Success</span>(access.reader(doc))
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-type">Failure</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">CapabilityException</span>(<span class="hljs-string">s"Cannot authorize <span class="hljs-subst">${ctx.user}</span> for writer to doc <span class="hljs-subst">$doc</span>"</span>))
    }
  }
}
</code></pre>
</div></div>
<p>A gatekeeper is not complicated, but it’s important to note it should be involved only when granting capabilities.</p>
<div class="row"><div class="a_linked small-expand columns a_xscroll a_codeblock">
<pre class="hljs"><code class="language-scala"><span class="hljs-comment">// Assume authentication happens up here...</span>
<span class="hljs-keyword">val</span> user = <span class="hljs-keyword">new</span> <span class="hljs-type">User</span>(<span class="hljs-string">"will"</span>)
<span class="hljs-keyword">implicit</span> <span class="hljs-keyword">val</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-type">SecurityContext</span>(will)

<span class="hljs-comment">// Access the document...</span>
<span class="hljs-keyword">val</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-type">Document</span>(user.name, path)

<span class="hljs-comment">// get reader or throw exception</span>
<span class="hljs-keyword">val</span> reader = gatekeeper.reader(doc).get

<span class="hljs-comment">// pass around reader to actor here...</span>
system.actorOf(<span class="hljs-type">DocumentActivityActor</span>.props(reader))

<span class="hljs-comment">// Or create new Activity class instance with reader as constructor parameter</span>
<span class="hljs-keyword">val</span> userActivity = <span class="hljs-keyword">new</span> <span class="hljs-type">DocumentActivity</span>(reader)
</code></pre>
</div></div>
<p>From the time the capability is accessible, it is “in scope” of the application code, and may be not tied to the lifecycle of the user session.  That is, there may be a job or a process which can run with the reader well after the user has logged out.  The <code class="hljs">SecurityContext</code> is only required by the gatekeeper, and is not required by any following activity.  There is no ambient authority.</p>
<p>The discussion around capabilities and their lifecycles, and how capabilities can be passed around and delegated to other classes is the biggest point of difference between permission based access control (which always requires an identity context) and capability based access control (which depends on an object reference).  In short, once you have assigned capabilities, you must then manage them.</p>

                 
  <ul class="menu align-right simple a_navbar a_navbar_bottom">
    
      
        <li><a href="management.html"  title="Managing Capabilities" ><span class="a_foundation_icon"></span>  Previous</a></li>
      
    
      
        <li><a href="confinement.html"  title="Confining Capabilities" ><span class="a_foundation_icon"></span>  Next</a></li>
      
    
      
        <li><a href="site-contents.html"  title="Table of Contents" ><span class="a_foundation_icon"></span>  Contents</a></li>
      
    
  </ul>
 
              </main>
              
              
                <div data-sticky-container class="small-12 medium-12 large-2 large-order-1 columns a_sitenav_container">
                  <nav class="a_sitenav" data-sticky data-sticky-on="large" data-anchor="_sections">
                    
                    <ul>
                       
  <li >
    
      
        <a href="index.html">Introduction</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="running.html">Running</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="guide.html">A Guide To Capabilities</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="introduction.html">Introducing Capabilities</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="creation.html">Creating Capabilities</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="management.html">Managing Capabilities</a>
      
    
    
  </li>
  
  <li  class="a_thispage" >
    
      
        <a href="authorization.html">Authorizing Capabilities</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="confinement.html">Confining Capabilities</a>
      
    
    
  </li>
  
  <li >
    
      
        <a href="other_works.html">Other works</a>
      
    
    
  </li>
 
                    </ul>
                    
                    
                  </nav>
                </div>
              
              
              
                <div class="small-12 medium-12 large-2 large-order-3 columns a_show-for-xlarge" data-sticky-container>
                  <nav class="a_pagenav" data-sticky data-sticky-on="large" data-anchor="_sections">
                     <header><p>On This Page</p>
</header> 
                    <ul class="vertical menu" data-magellan>
                       
  
    <li>
      
         <a href="#authorizing-capabilities">Authorizing Capabilities</a> 
      
      
        <ul class="vertical menu">  
  
    <li>
      
         <a href="#a-brief-history-of-authorization">A Brief History of Authorization</a> 
      
      
    </li>
  
  
  
    <li>
      
         <a href="#authorizating-capabilities-with-gatekeeper">Authorizating Capabilities with Gatekeeper</a> 
      
      
    </li>
  
  </ul>
      
    </li>
  
 
                    </ul>
                  </nav>
                </div>
              
            </div>
          </div>
        </div>
      </div>
      
      <footer class="small-12 medium-12 large-12 columns align-self-bottom a_footer">
        <div class="row">
          <div class="small-12 medium-12 large-12 columns top-bar">
            <div class="top-bar-left">
              <p>© Copyright 2018 Will Sargent</p>

            </div>
            <div class="top-bar-right">
              <p>Generated with <a href="https://github.com/szeiger/ornate">Ornate</a>.</p>

            </div>
          </div>
        </div>
      </footer>
    </div>
    
    <script src="theme/js/jquery.min.js"></script>
    <script src="theme/js/what-input.min.js"></script>
    <script src="theme/js/foundation.min.js"></script>
    
    <script src="theme/js/app.js"></script>
    
  </body>
</html>
