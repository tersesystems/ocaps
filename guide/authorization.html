<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="ocaps">
<meta name="generator" content="Paradox, paradox-material-theme=0.4.0, mkdocs-material=2.2.2">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.language" content="">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="ocaps">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Authorizing Capabilities · ocaps</title>
<link rel="stylesheet" href="../assets/stylesheets/application.7a4cdee3.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../lib/modernizr/modernizr.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
<label class="md-overlay" data-md-component="overlay" for="drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="ocaps" class="md-header-nav__button md-logo">
<i class="md-icon">local_library</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
ocaps
</span>
<span class="md-header-nav__topic">
Authorizing Capabilities
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="search"></label>
<div class="md-search__inner">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
<label class="md-icon md-search__icon" for="search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<span class="md-nav__button md-logo">
<i class="md-icon">local_library</i>
</span>
<a href="../index.html" title="ocaps">
ocaps
</a>
</label>
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction.html" class="page">Construction</a></li>
    <li><a href="../examples/effects.html" class="page">Construction with Effects</a></li>
    <li><a href="../examples/subtypes.html" class="page">Construction with Subtypes</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="active page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../guide/authorization.html#authorizing-capabilities" class="header">Authorizing Capabilities</a>
  <ul>
    <li><a href="../guide/authorization.html#authorization-and-ambient-authority" class="header">Authorization and Ambient Authority</a></li>
    <li><a href="../guide/authorization.html#authorizating-capabilities-with-gatekeeper" class="header">Authorizating Capabilities with Gatekeeper</a></li>
    <li><a href="../guide/authorization.html#dispensing-capabilities-with-composition" class="header">Dispensing Capabilities with Composition</a></li>
  </ul></li>
</ul>
</nav>

<div class="md-nav__title--site md-version" title="Version">
<i class="md-icon">label_outline</i> 0.1.1*
</div>
</nav>

</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="toc">Table of contents</label>
<ul>
  <li><a href="../guide/authorization.html#authorizing-capabilities" class="header">Authorizing Capabilities</a>
  <ul>
    <li><a href="../guide/authorization.html#authorization-and-ambient-authority" class="header">Authorization and Ambient Authority</a></li>
    <li><a href="../guide/authorization.html#authorizating-capabilities-with-gatekeeper" class="header">Authorizating Capabilities with Gatekeeper</a></li>
    <li><a href="../guide/authorization.html#dispensing-capabilities-with-composition" class="header">Dispensing Capabilities with Composition</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#authorizing-capabilities" name="authorizing-capabilities" class="anchor"><span class="anchor-link"></span></a>Authorizing Capabilities</h1>
<h2><a href="#authorization-and-ambient-authority" name="authorization-and-ambient-authority" class="anchor"><span class="anchor-link"></span></a>Authorization and Ambient Authority</h2>
<p>One of the issues that the capability model neatly sidesteps is the issue of <a href="https://en.wikipedia.org/wiki/Ambient_authority">ambient authority</a>. </p>
<p>Broadly speaking, ambient authority is when a user or a security context (also known as a &ldquo;Principal&rdquo;) is assumed to exist when making sensitive calls, and the credentials of the &ldquo;current user&rdquo; are applied every time.</p>
<p>In Java, ambient authority would typically come in the form of a thread-local user context that would be accessible from every method. In Scala, it typically takes the form of an implicit <code>User</code> or <code>SecurityContext</code> that is always accessible.</p>
<p>In a capability model, authorization is used only and solely to dispense the capability. After that point, the capability is passed around without an implicit <code>SecurityContext</code> and without ambient authority. If the user logs out at any point, then the capability is revoked.</p>
<h2><a href="#authorizating-capabilities-with-gatekeeper" name="authorizating-capabilities-with-gatekeeper" class="anchor"><span class="anchor-link"></span></a>Authorizating Capabilities with Gatekeeper</h2>
<p>Handing out a capability to an object gives the object authority over the resource. The question of whether that object should have authority or not is an authorization decision. The question of authorization (&ldquo;what authority&rdquo;) is usually accompanied by the question of authentication (&ldquo;who should have this authority?&rdquo;).</p>
<p>In capability based systems, there are four stages before a capability is handed out. <a href="https://youtu.be/XQWY9_BcSGI?t=8m40s">Alan Karp</a> defines four stages:</p>
<ol>
  <li>Identification (grant privs)</li>
  <li>Authentication (let a process running on behalf use priv associated with identity)</li>
  <li>Authorization (grant token, etc)</li>
  <li>Access Decision (in the service)</li>
</ol>
<p>Capability-based authorization systems identify a policy that says who is authorized for an operation on a resource, and then hand out a capability for that operation. That capability is then used directly. This is in contrast to role based access control (RBAC), which ties in the identity directly. Examples include <a href="https://en.wikipedia.org/wiki/OAuth#OAuth_2.0">OAuth 2 Bearer Token</a> and <a href="https://en.wikipedia.org/wiki/XACML">XACML</a>, but it&rsquo;s quite simple to create your own.</p>
<p>This may not mean much in isolation, so let&rsquo;s run through an example with Scala code, implementing a Gatekeeper class for documents.</p>
<blockquote>
  <p>You can see the full class in <a href="../examples/gatekeeper.html">Gatekeeper example</a> page.</p>
</blockquote>
<p>First, we need authentication. Let&rsquo;s posit a <code>User</code> class that serves as the <a href="https://stackoverflow.com/a/5025140">principal</a>, and an implicit <code>SecurityContext</code> that serves as an <a href="http://www.lihaoyi.com/post/ImplicitDesignPatternsinScala.html#implicit-contexts">implicit context</a>. </p>
<pre class="prettyprint"><code class="language-scala">case class User(name: String)
class SecurityContext(val user: User)
</code></pre>
<p>We also need to extend <code>Document</code> slightly to have an <code>owner</code> field: </p>
<pre class="prettyprint"><code class="language-scala">final class Document private(val owner: String,
                             private[this] val path: Path) {
   ...
}
</code></pre>
<p>Next, we put together a <code>DocumentGatekeeper</code>. This takes a <code>reader(doc: Document)</code> with the <code>SecurityContext</code> as an implicit parameter, and returns the <code>Document.Reader</code> capability only if it passes the document policy.</p>
<pre class="prettyprint"><code class="language-scala">class DocumentGatekeeper() {

  private class DocumentPolicy {
    def canRead(user: User, doc: Document): Boolean = {
      isDocumentOwner(user, doc) || isAdmin(user)
    }
    private def isDocumentOwner(user: User, doc: Document): Boolean = {
      doc.owner.equals(user.name) || isAdmin(user)
    }
    private def isAdmin(user: User): Boolean = {
      user.name.equals(&quot;admin&quot;)
    }
  }

  private val access = Document.Access()
  private val policy = new DocumentPolicy
  
  def reader(doc: Document)(implicit ctx: SecurityContext): Try[Reader] = {
    if (policy.canRead(ctx.user, doc)) {
      Success(access.reader(doc))
    } else {
      Failure(new CapabilityException(s&quot;Cannot authorize ${ctx.user} for writer to doc $doc&quot;))
    }
  }
}
</code></pre>
<p>A gatekeeper is not complicated, but it&rsquo;s important to note it should be involved only when granting capabilities.</p>
<pre class="prettyprint"><code class="language-scala">// Assume authentication happens up here...
val user = new User(&quot;will&quot;)
implicit val sc = new SecurityContext(will)

// Access the document...
val doc = new Document(user.name, path)

// get reader or throw exception
val reader = gatekeeper.reader(doc).get

// pass around reader to actor here...
system.actorOf(DocumentActivityActor.props(reader))

// Or create new Activity class instance with reader as constructor parameter
val userActivity = new DocumentActivity(reader)
</code></pre>
<p>From the time the capability is accessible, it is &ldquo;in scope&rdquo; of the application code, and may be not tied to the lifecycle of the user session. That is, there may be a job or a process which can run with the reader well after the user has logged out. The <code>SecurityContext</code> is only required by the gatekeeper, and is not required by any following activity. There is no ambient authority.</p>
<p>The discussion around capabilities and their lifecycles, and how capabilities can be passed around and delegated to other classes is the biggest point of difference between permission based access control (which always requires an identity context) and capability based access control (which depends on an object reference). In short, once you have assigned capabilities, you must then manage them.</p>
<h2><a href="#dispensing-capabilities-with-composition" name="dispensing-capabilities-with-composition" class="anchor"><span class="anchor-link"></span></a>Dispensing Capabilities with Composition</h2>
<p>When there are several capabilities that may be available from authorization, one common pattern is to return a set of capabilities to the caller, providing a range of options.</p>
<pre class="prettyprint"><code class="language-scala">class Caller(capabilities: Set[Capability]) {
 ...
}

val capabilitySet = Set(reader, writer)
val caller = new Caller(capabilitySet)
</code></pre>
<p>Note that <code>Caller</code> does not know what capabilities may be presented to it, and so must iterate to see if it has access. This is fine as far as it goes, but it does inherently provide collection mechanics on top of managing capabilities, and loses some type information.</p>
<p>Another option is to use <em>composition</em> to return an object that directly incorporates all the capabilities.</p>
<pre class="prettyprint"><code class="language-scala">class Caller(caps: Reader with Writer) {
 ...
}

val capabilities = ocap.macros.compose[Reader with Writer](reader, writer)
val caller = new Caller(capabilities)
</code></pre>
<p>Now the caller can pattern match directly against the capability:</p>
<pre class="prettyprint"><code class="language-scala">class Caller(capabilities: AnyRef) {
  private def reader: Option[Reader] = {
    capabilities match {
      case reader: Reader =&gt;
        Some(reader)
      case _ =&gt;
        None
    }
  }
}
</code></pre>
<p>Or, if the caller has specific type information that is needed from a composed capability, the provider can extract the facets through <em>attenuation</em>:</p>
<pre class="prettyprint"><code class="language-scala">class Caller(reader: Reader, writer: Writer) {
  ...
}

val reader: Reader = ocaps.macros.attenuate[Reader](capabilities)
val writer: Writer = ocaps.macros.attenuate[Writer](capabilities)

val caller = new Caller(reader, writer)
</code></pre>
<p>You can see a complete <a href="../examples/attenuation.html">attenuation example</a> for more details. Also see the <a href="../examples/gatekeeper.md">gatekeeper example</a>.</p>
<p>Composition is not the only way of arranging capabilities, of course. Joe Duffy has a great <a href="http://joeduffyblog.com/2015/11/10/objects-as-secure-capabilities/">post</a> where he discusses the practical aspects of capabilities:</p>
<blockquote>
  <p>I’ll be the first to admit, there was a maturity process that developers went through, as they learned about the design patterns in an object capability system. It was common for “big bags” of capabilities to grow over time, and/or for capabilities to be requested at an inopportune time. For example, imagine a Stopwatch API. It probably needs the Clock. Do you pass the Clock to every operation that needs to access the current time, like Start and Stop? Or do you construct the Stopwatch with a Clock instance up-front, thereby encapsulating the Stopwatch’s use of the time, making it easier to pass to others (recognizing, importantly, that this essentially grants the capability to read the time to the recipient). Another example, if your abstraction requires 15 distinct capabilities to get its job done, does its constructor take a flat list of 15 objects? What an unwieldy, annoying constructor! Instead, a better approach is to logically group these capabilities into separate objects, and maybe even use contextual storage like parents and children to make fetching them easier.</p>
</blockquote>
<p>As in all things, choose the solution that works best for your context.</p>
</div>
<div>
<a href="https://github.com/wsargent/ocaps/tree/master/src/paradox/guide/authorization.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.1*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../guide/construction.html" title="Constructing Capabilities" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Constructing Capabilities
</span>
</div>
</a>
<a href="../guide/management.html" title="Managing Capabilities" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Managing Capabilities
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.5165553b.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
</body>
</html>
