<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Authorizing Capabilities · ocaps</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='ocaps'/>
<link rel="canonical" href="https://github.com/tersesystems/ocapsguide/authorization.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>ocaps
</a>
<div class="version-number">
1.0.0*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction/index.html" class="page">Construction</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/expiration.html" class="page">Expiration</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/abstraction.html" class="page">Abstraction</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
    <li><a href="../examples/horton.html" class="page">Responsibility Tracking (Horton)</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="active page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">ocaps</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>ocaps
</a>
<div class="version-number">
1.0.0*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction/index.html" class="page">Construction</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/expiration.html" class="page">Expiration</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/abstraction.html" class="page">Abstraction</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
    <li><a href="../examples/horton.html" class="page">Responsibility Tracking (Horton)</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="active page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">ocaps</a></li>
  <li><a href="../guide/index.html">A Guide To Capabilities</a></li>
  <li>Authorizing Capabilities</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#authorizing-capabilities" name="authorizing-capabilities" class="anchor"><span class="anchor-link"></span></a>Authorizing Capabilities</h1>
<h2><a href="#authorization-and-ambient-authority" name="authorization-and-ambient-authority" class="anchor"><span class="anchor-link"></span></a>Authorization and Ambient Authority</h2>
<p>One of the issues that the capability model neatly sidesteps is the issue of <a href="https://en.wikipedia.org/wiki/Ambient_authority">ambient authority</a>. </p>
<p>Broadly speaking, ambient authority is when a user or a security context (also known as a &ldquo;Principal&rdquo;) is assumed to exist when making sensitive calls, and the credentials of the &ldquo;current user&rdquo; are applied every time.</p>
<p>In Java, ambient authority would typically come in the form of a thread-local user context that would be accessible from every method. In Scala, it typically takes the form of an implicit <code>User</code> or <code>SecurityContext</code> that is always accessible.</p>
<p>In a capability model, authorization is used only and solely to dispense the capability. After that point, the capability is passed around without an implicit <code>SecurityContext</code> and without ambient authority. If the user logs out at any point, then the capability is revoked.</p>
<h2><a href="#authorizating-capabilities-with-gatekeeper" name="authorizating-capabilities-with-gatekeeper" class="anchor"><span class="anchor-link"></span></a>Authorizating Capabilities with Gatekeeper</h2>
<p>Handing out a capability to an object gives the object authority over the resource. The question of whether that object should have authority or not is an authorization decision. The question of authorization (&ldquo;what authority&rdquo;) is usually accompanied by the question of authentication (&ldquo;who should have this authority?&rdquo;).</p>
<p>In capability based systems, there are four stages before a capability is handed out. <a href="https://youtu.be/XQWY9_BcSGI?t=8m40s">Alan Karp</a> defines four stages:</p>
<ol>
  <li>Identification (grant privs)</li>
  <li>Authentication (let a process running on behalf use priv associated with identity)</li>
  <li>Authorization (grant token, etc)</li>
  <li>Access Decision (in the service)</li>
</ol>
<p>Capability-based authorization systems identify a policy that says who is authorized for an operation on a resource, and then hand out a capability for that operation. That capability is then used directly. This is in contrast to role based access control (RBAC), which ties in the identity directly. Examples include <a href="https://en.wikipedia.org/wiki/OAuth#OAuth_2.0">OAuth 2 Bearer Token</a> and <a href="https://en.wikipedia.org/wiki/XACML">XACML</a>, but it&rsquo;s quite simple to create your own.</p>
<p>This may not mean much in isolation, so let&rsquo;s run through an example with Scala code, implementing a Gatekeeper class for documents.</p>
<blockquote>
  <p>You can see the full class in <a href="../examples/gatekeeper.html">Gatekeeper example</a> page.</p>
</blockquote>
<p>First, we need authentication. Let&rsquo;s posit a <code>User</code> class that serves as the <a href="https://stackoverflow.com/a/5025140">principal</a>, and an implicit <code>SecurityContext</code> that serves as an <a href="http://www.lihaoyi.com/post/ImplicitDesignPatternsinScala.html#implicit-contexts">implicit context</a>. </p>
<pre class="prettyprint"><code class="language-scala">case class User(name: String)
class SecurityContext(val user: User)
</code></pre>
<p>We also need to extend <code>Document</code> slightly to have an <code>owner</code> field: </p>
<pre class="prettyprint"><code class="language-scala">final class Document private(val owner: String,
                             private[this] val path: Path) {
   ...
}
</code></pre>
<p>Next, we put together a <code>DocumentGatekeeper</code>. This takes a <code>reader(doc: Document)</code> with the <code>SecurityContext</code> as an implicit parameter, and returns the <code>Document.Reader</code> capability only if it passes the document policy.</p>
<pre class="prettyprint"><code class="language-scala">class DocumentGatekeeper() {

  private class DocumentPolicy {
    def canRead(user: User, doc: Document): Boolean = {
      isDocumentOwner(user, doc) 
    }
    private def isDocumentOwner(user: User, doc: Document): Boolean = {
      doc.owner.equals(user.name)
    }
  }

  private val access = Document.Access()
  private val policy = new DocumentPolicy
  
  def reader(doc: Document)(implicit ctx: SecurityContext): Try[Reader] = {
    if (policy.canRead(ctx.user, doc)) {
      Success(access.reader(doc))
    } else {
      Failure(new CapabilityException(s&quot;Cannot authorize ${ctx.user} for writer to doc $doc&quot;))
    }
  }
}
</code></pre>
<p>A gatekeeper is not complicated, but it&rsquo;s important to note it should be involved only when granting capabilities.</p>
<pre class="prettyprint"><code class="language-scala">// Assume authentication happens up here...
val user = new User(&quot;will&quot;)
implicit val sc = new SecurityContext(will)

// Access the document...
val doc = new Document(user.name, path)

// get reader or throw exception
val reader = gatekeeper.reader(doc).get

// pass around reader to actor here...
system.actorOf(DocumentActivityActor.props(reader))

// Or create new Activity class instance with reader as constructor parameter
val userActivity = new DocumentActivity(reader)
</code></pre>
<p>From the time the capability is accessible, it is &ldquo;in scope&rdquo; of the application code, and may be not tied to the lifecycle of the user session. That is, there may be a job or a process which can run with the reader well after the user has logged out. The <code>SecurityContext</code> is only required by the gatekeeper, and is not required by any following activity. There is no ambient authority.</p>
<p>The discussion around capabilities and their lifecycles, and how capabilities can be passed around and delegated to other classes is the biggest point of difference between permission based access control (which always requires an identity context) and capability based access control (which depends on an object reference). In short, once you have assigned capabilities, you must then manage them.</p>
<h2><a href="#dispensing-capabilities-with-composition" name="dispensing-capabilities-with-composition" class="anchor"><span class="anchor-link"></span></a>Dispensing Capabilities with Composition</h2>
<p>When there are several capabilities that may be available from authorization, one common pattern is to return a set of capabilities to the caller, providing a range of options.</p>
<pre class="prettyprint"><code class="language-scala">class Caller(capabilities: Set[Capability]) {
 ...
}

val capabilitySet = Set(reader, writer)
val caller = new Caller(capabilitySet)
</code></pre>
<p>Note that <code>Caller</code> does not know what capabilities may be presented to it, and so must iterate to see if it has access. This is fine as far as it goes, but it does inherently provide collection mechanics on top of managing capabilities, and loses some type information.</p>
<p>Another option is to use <em>composition</em> to return an object that directly incorporates all the capabilities.</p>
<pre class="prettyprint"><code class="language-scala">class Caller(caps: Reader with Writer) {
 ...
}

val capabilities = ocap.macros.compose[Reader with Writer](reader, writer)
val caller = new Caller(capabilities)
</code></pre>
<p>Now the caller can pattern match directly against the capability:</p>
<pre class="prettyprint"><code class="language-scala">class Caller(capabilities: AnyRef) {
  private def reader: Option[Reader] = {
    capabilities match {
      case reader: Reader =&gt;
        Some(reader)
      case _ =&gt;
        None
    }
  }
}
</code></pre>
<p>Or, if the caller has specific type information that is needed from a composed capability, the provider can extract the facets through <em>attenuation</em>:</p>
<pre class="prettyprint"><code class="language-scala">class Caller(reader: Reader, writer: Writer) {
  ...
}

val reader: Reader = ocaps.macros.attenuate[Reader](capabilities)
val writer: Writer = ocaps.macros.attenuate[Writer](capabilities)

val caller = new Caller(reader, writer)
</code></pre>
<p>You can see a complete <a href="../examples/attenuation.html">attenuation example</a> for more details. Also see the <a href="../examples/gatekeeper.html">gatekeeper example</a>.</p>
<p>Composition is not the only way of arranging capabilities, of course. Joe Duffy has a great <a href="http://joeduffyblog.com/2015/11/10/objects-as-secure-capabilities/">post</a> where he discusses the practical aspects of capabilities:</p>
<blockquote>
  <p>I’ll be the first to admit, there was a maturity process that developers went through, as they learned about the design patterns in an object capability system. It was common for “big bags” of capabilities to grow over time, and/or for capabilities to be requested at an inopportune time. For example, imagine a Stopwatch API. It probably needs the Clock. Do you pass the Clock to every operation that needs to access the current time, like Start and Stop? Or do you construct the Stopwatch with a Clock instance up-front, thereby encapsulating the Stopwatch’s use of the time, making it easier to pass to others (recognizing, importantly, that this essentially grants the capability to read the time to the recipient). Another example, if your abstraction requires 15 distinct capabilities to get its job done, does its constructor take a flat list of 15 objects? What an unwieldy, annoying constructor! Instead, a better approach is to logically group these capabilities into separate objects, and maybe even use contextual storage like parents and children to make fetching them easier.</p>
</blockquote>
<p>As in all things, choose the solution that works best for your context.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/ocaps/tree/master/src/main/paradox/guide/authorization.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../guide/management.html">Managing Capabilities</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../guide/authorization.html#authorizing-capabilities" class="header">Authorizing Capabilities</a>
  <ul>
    <li><a href="../guide/authorization.html#authorization-and-ambient-authority" class="header">Authorization and Ambient Authority</a></li>
    <li><a href="../guide/authorization.html#authorizating-capabilities-with-gatekeeper" class="header">Authorizating Capabilities with Gatekeeper</a></li>
    <li><a href="../guide/authorization.html#dispensing-capabilities-with-composition" class="header">Dispensing Capabilities with Composition</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2024</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0-SNAPSHOT', 'https://github.com/tersesystems/ocaps')});</script>


</html>
