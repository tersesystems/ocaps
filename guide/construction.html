<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Constructing Capabilities · ocaps</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='ocaps'/>
<link rel="canonical" href="https://github.com/tersesystems/ocapsguide/construction.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>ocaps
</a>
<div class="version-number">
1.0.0*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction/index.html" class="page">Construction</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/expiration.html" class="page">Expiration</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/abstraction.html" class="page">Abstraction</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
    <li><a href="../examples/horton.html" class="page">Responsibility Tracking (Horton)</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="active page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">ocaps</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>ocaps
</a>
<div class="version-number">
1.0.0*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction/index.html" class="page">Construction</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/expiration.html" class="page">Expiration</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/abstraction.html" class="page">Abstraction</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
    <li><a href="../examples/horton.html" class="page">Responsibility Tracking (Horton)</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="active page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">ocaps</a></li>
  <li><a href="../guide/index.html">A Guide To Capabilities</a></li>
  <li>Constructing Capabilities</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#constructing-capabilities" name="constructing-capabilities" class="anchor"><span class="anchor-link"></span></a>Constructing Capabilities</h1>
<p>The introduction gave a basic explanation of capabilities, but did not demonstrate why access to the capability is so important.</p>
<p>In esssence, a capability is a programming level expression of the saying &ldquo;You can only eat your cake if you have it.&rdquo; </p>
<pre class="prettyprint"><code class="language-scala">trait Cake {
  def eat(): Unit
}
val cake = new Cake() {
  def eat() = ()
}
cake.eat()
</code></pre><div class="mermaid">
graph LR
  You -->|cake|ci((Cake object))
</div>
<p>You may know that a resource (an instance of <code>Cake</code>) exists, but you still need an object reference <code>cake</code> in order to affect the <code>Cake</code> instance by calling the <code>eat()</code> method on it. This is a fairly trivial example, because if you can instantiate a cake yourself, you will have no problem referencing it.</p>
<p>Things start getting more interesting when you add more objects, and you don&rsquo;t control or instantiate resources directly. For example, you may not be able to make cakes yourself, so you go to a bakery.</p>
<pre class="prettyprint"><code class="language-scala">trait Bakery {
  def buy(): Cake 
}

class Person(val bakery: Bakery) {
  def buyAndEatCake() = eatCake(bakery.buy())
  def eatCake(cake: Cake) = cake.eat()    
}
val bakery = new Bakery() {
  def buy(): Cake = new Cake() { 
    def eat() = ()
  }
}
val you = new Person(bakery)
you.buyAndEatCake()
</code></pre><div class="mermaid">
graph LR
  You --> bi((Bakery))
  bi --> ci((Cake))
</div>
<p>Here, you&rsquo;re still interested in affecting a resource <code>Cake</code> by, well, eating it, but you don&rsquo;t have direct access to the cake. Instead, <code>you</code>, an instance of a <code>Person</code>, have a reference to a <code>Bakery</code>, and that <code>Bakery</code> may give you a cake. </p>
<p>Note that because <code>bakery</code> is an object reference, it is also a capability. You can&rsquo;t buy things from a bakery unless you know how to get to one.</p>
<p>The bakery may give you a cake. But it may throw an exception, because they don&rsquo;t have cakes or you don&rsquo;t have enough money, or because they&rsquo;re closed. In addition, you don&rsquo;t control the behavior of the <code>eat</code> method. You have a reference, but that reference is a contract and it&rsquo;s the object that chooses how to execute it &ndash; when you call <code>cake.eat()</code>, that may also throw an exception or do something behind the scenes. </p>
<p>And this is where the power of capabilities comes in. As it stands, you can eat a cake as often as you like. The bakery may want you to only eat a cake once. Because the bakery controls access to the resource, it can enforce a capability policy around the eating of cake.</p>
<pre class="prettyprint"><code class="language-scala">val enforcingBakery = new Bakery() {
  def buy(): Cake = {
    val latch = new java.util.concurrent.atomic.AtomicInteger(1)
    val realCake = new Cake() {
      def eat() = ()
    }
    new Cake() {
      def eat() = {
        if (latch.getAndDecrement == 1) {
          realCake.eat()
        } else {
          throw new RuntimeException(&quot;You have already eaten this cake!&quot;)
        }
      }
    }
  }
}

val sneakyYou = new Person(enforcingBakery)
val oneTimeCake = sneakyYou.bakery.buy()
sneakyYou.eatCake(oneTimeCake)
sneakyYou.eatCake(oneTimeCake)
</code></pre><div class="mermaid">
graph LR
  sneakyYou --> ci((Cake Proxy))
  ci --> rc((Real Cake))
</div>
<p>You may get an object reference &ndash; a capability &ndash; to a <code>Cake</code>. But here, the actual cake is only accessible through a delegate (also called a &ldquo;forwarder&rdquo;) which proxies the call. You have no direct access to the resource (<code>realCake</code>), and you can affect the resource (call <code>realCake.eat()</code>) only if the proxy allows it. The proxy may refuse to proxy the call. This is called <em>revocation</em>, and it is a key part of capability-based systems.</p>
<p>So if the only way you can get a cake is through a bakery, then you have to play by the bakery&rsquo;s rules.</p>
<h2><a href="#capabilities-as-traits" name="capabilities-as-traits" class="anchor"><span class="anchor-link"></span></a>Capabilities as Traits</h2>
<p>Because capabilities are references, referring to a <code>Cake</code> class is perfectly legal. However, given the nature of capabilities as a security primitive, implementing a capability as a class limits functionality, because it is trickier to implement behavior that usually requires forwarding proxies, such as <em>revocation</em> and <em>composition</em>. </p>
<p>In most cases, using a pure trait with no behavior is the safest choice. For example, rather than having a reference to a <code>Cake</code> class, implementing an <code>Eatable</code> trait that contains a method <code>eat()</code> would be more convenient as a capability, and then <code>Cake</code> can implement that interface:</p>
<pre class="prettyprint"><code class="language-scala">trait Eatable {
  def eat()
}

class Cake extends Eatable {
  ...
}
</code></pre>
<p>Now, we know that we can <code>eat</code> the cake, because it is <code>Eatable</code>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Avoid default methods and default parameters on traits. They add behavior, and interfere with <code>ocaps</code> macros.</p></div>
<p>Note that <code>Eatable</code> is a Single Abstract Method (SAM) trait. Capabilities are not required to only implement a single method, but it can make things more convenient. An example of a capability that could implement several methods would be a <code>FileReader</code> which could return either a byte-oriented stream, or a character oriented stream:</p>
<pre class="prettyprint"><code class="language-scala">trait Reader {
  def bufferedReader[T](block: BufferedReader =&gt; T): T

  def inputStream[T](block: InputStream =&gt; T): T
}
</code></pre>
<p>Note that only a <code>BufferedReader</code> or an <code>InputStream</code> are returned here. This is because exposing a <code>java.io.File</code> object can lead to manipulation of the filesystem, causing the capability to &ldquo;leak&rdquo; information and expose additional privileges that were not explicitly granted. </p><div class="callout warning "><div class="callout-title">Warning</div>
<p>Be careful that your capability does not leak extra functionality!</p></div>
<h3><a href="#traits-vs-anonymous-functions" name="traits-vs-anonymous-functions" class="anchor"><span class="anchor-link"></span></a>Traits vs Anonymous Functions</h3>
<p>There&rsquo;s an argument that anonymous functions such as <code>FunctionN</code> are natural capabilities.</p>
<p>Anonymous functions are good for many things, but they have the following drawbacks compared to explicit traits:</p>
<ul>
  <li>Anonymous functions are anonymous. One <code>() =&gt; ()</code> looks much the same as another, so it&rsquo;s harder to track where a capability is exposed through IDE.</li>
  <li>Anonymous functions are opaque. When you see an <code>Eatable</code>, you know what it does. A <code>() =&gt; ()</code> method could do anything.</li>
  <li>Anonymous functions are not refactorable. If you have an <code>Eatable</code> trait, you can add more methods to it, subtype, change the name where appropriate.</li>
</ul>
<p>A similar argument applies to <code>java.lang.Runnable</code> and other SAM traits that are part of the Java platform: they are not part of the domain, and they are intended for different purposes. It&rsquo;s always possible to turn a SAM trait into an anonymous function when necessary, but the reverse is not possible. </p>
<p>If a drop in is required, then extending an anonymous function type is acceptable, i.e.</p>
<pre class="prettyprint"><code class="language-scala">trait Doer extends (String =&gt; Unit)
</code></pre>
<p>Although personally I still don&rsquo;t like this, because subclassing means that you can still downcast to <code>Function1</code> and lose the trait information.</p>
<h2><a href="#construction-through-composition" name="construction-through-composition" class="anchor"><span class="anchor-link"></span></a>Construction Through Composition</h2>
<p>Let&rsquo;s dig a little deeper and discuss capabilities in the context of a <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> based repository, and show how resources and capabilities interact, and how to expose capabilities.</p>
<blockquote>
  <p>It&rsquo;s worth noticing that because a capability is an object reference, a resource which has an exposed capability is always referencable and so will not be eligible for garbage collection. In certain cases, we have many capabilities to resources which are no longer valid, such as cached items, or may have open filehandles. You should use or <code>ocaps.WeakResource</code> to wrap access to a resource in a <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/ref/WeakReference.html">weak reference</a>.</p>
</blockquote>
<p>When you think of a repository, you usually think of something like the following:</p>
<pre class="prettyprint"><code class="language-scala">import scala.concurrent._
case class Item(id: UUID, name: String)
trait ItemRepository {
  def create(item: Item): Future[Item]
  def update(item: Item): Future[Item]
  def delete(id: UUID): Future[Unit]
  def find(id: UUID): Future[Option[Item]]
}
</code></pre>
<p>However, recall the first rule: if you have a cake, you can eat it. If you have access to an <code>ItemRepository</code>, you can call all of the methods available on <code>ItemRepository</code>. If a class just wants to query for an item, it doesn&rsquo;t need the ability to create, update or delete that item. </p>
<pre class="prettyprint"><code class="language-scala">case class Item(id: UUID, name: String)
object ItemRepository {
  trait Finder {
    def find(id: UUID): Future[Option[Item]]
  }
  trait Updater {
    def update(item: Item): Future[Item]
  }
  trait Deleter {
    def delete(id: UUID): Future[Unit]
  }
  trait Creator {
    def create(item: Item): Future[Item]
  }
}
trait ItemRepository 
  extends ItemRepository.Finder 
  with ItemRepository.Updater
  with ItemRepository.Creator
  with ItemRepository.Deleter
</code></pre>
<p>Here, we&rsquo;ve broken down the individual methods of the <code>ItemRepository</code> into a series of traits. Rather than exposing the <code>ItemRepository</code> itself, we can expose the traits individually, and build up the repository as a <em>composition</em> of capabilities. </p>
<pre class="prettyprint"><code class="language-scala">val item = Item(UUID.randomUUID(), &quot;item&quot;)
val repo = new ItemRepository() {
  def create(item: Item): Future[Item] = Future.successful(item)
  def update(item: Item): Future[Item] = Future.successful(item)
  def delete(id: UUID): Future[Unit] = Future.successful(())
  def find(id: UUID): Future[Option[Item]] = Future.successful(item)
}

val finder = new ItemRepository.Finder() {
  def find(id: UUID): Future[Option[Item]] = repo.finder(id)
}
</code></pre>
<p>When we have a pattern like this, where capabilities have a shared underlying resource, we say that they are facets of the resource. In this case, we have a <code>finder</code> facet of the <code>ItemRepository</code> resource. </p>
<p>You would think that since <code>ItemRepository</code> implements the <code>Finder</code> trait itself, that you could just pass it around directly. The problem there is that an object reference is still an object reference <strong>no matter what type you give it</strong>. As such, you can get access to the other facets by downcasting to <code>ItemRepository</code>:</p>
<pre class="prettyprint"><code class="language-scala">val onlyAFinder: ItemRepository.Finder = repo
val recoveredRepo: ItemRepository = onlyAFinder.asInstanceOf[ItemRepository]
recoveredRepo.delete(ID) // oh dear, we only wanted to give you a finder.
</code></pre>
<p>So instead, we create a new <code>Finder</code> instance, and proxy through to <code>repo.finder</code>. This is called <em>attenuation</em>. You can use an ocaps macro to write this code for you automatically:</p>
<pre class="prettyprint"><code class="language-scala">val attenuatedFinder: ItemRepository.Finder = ocaps.macros.attenuate[ItemRepository.Finder](repo)
</code></pre>
<p>Facets do not have to be created through attenuation, and in some cases it&rsquo;s undesirable because it fixes traits onto the resource. We&rsquo;ll show another way facets can be created later in this section.</p>
<p>Now we have the facet, we can use it in other operations:</p>
<pre class="prettyprint"><code class="language-scala">class NameChanger(finder: ItemRepository.Finder) {
  def findName(id: String): Future[String] = finder.find(id).map { maybeItem =&gt;
    maybeItem.map(_.name)
  }
}
</code></pre>
<h2><a href="#effects-in-capabilities-with-tagless-final" name="effects-in-capabilities-with-tagless-final" class="anchor"><span class="anchor-link"></span></a>Effects in Capabilities with Tagless Final</h2>
<p>Rather than throwing exceptions as a side effect, capabilities can make use of functional programming techniques. For example, rather than commit to a <code>monix.Task[_]</code> or a <code>Try[_]</code>, a capability may be expressed in <a href="https://www.beyondthelines.net/programming/introduction-to-tagless-final/">tagless final</a> style with a type parameter <code>F</code> that is a standin for the thing you want: </p>
<pre class="prettyprint"><code class="language-scala">object ItemRepository {
  trait Finder[F[_]] {
    def find(id: UUID): F[Option[Item]]
  }
}
</code></pre>
<p>We refer to this as an effect, where effect means &ldquo;whatever distinguishes <code>F[A]</code> from <code>A</code>.&rdquo;</p>
<p>The <code>capabilities</code> companion is defined using <code>cat.Id</code>, which essentially means &ldquo;no effect here&rdquo;:</p>
<pre class="prettyprint"><code class="language-scala">import cats._
class ItemRepository {
  import ItemRepository._
  private val items = Seq(Item(UUID.randomUUID(), &quot;item name&quot;))
  private object capabilities {
    val finder: Finder[Id] = new Finder[Id]() {
      override def find(id: UUID): Id[Option[Item]] = items.find(_.id == id)
    }
  }
}
</code></pre>
<p>And then the effect &ndash; in this case <code>Try</code> &ndash; can be wrapped around the original capability instance.</p>
<pre class="prettyprint"><code class="language-scala">val idFinder = access.finder(itemRepository)
val tryFinder: Finder[Try] = new Finder[Try] {
  override def find(id: UUID): Try[Option[Item]] = Try(idFinder.find(id))
}
</code></pre>
<p>When using <code>Try</code>, the <code>find</code> method will return either <code>Success(maybeItem)</code> or <code>Failure(throwable)</code> as a result, rather than throwing an exception up the stack.</p>
<h2><a href="#construction-through-access" name="construction-through-access" class="anchor"><span class="anchor-link"></span></a>Construction Through Access</h2>
<p>Creating a resource which exposes all its public methods is very convenient in situations where direct access to the resource is tightly restricted, and all external access is regulated through facets. This is not always the case: for example, in an Inversion-of-Control container like Spring or Guice, all resources are accessible, i.e.</p>
<pre class="prettyprint"><code class="language-scala">val repoThroughGuice = injector.instanceOf(classOf[ItemRepository])
repoThroughGuice.delete(&quot;1&quot;) // anyone can delete
</code></pre>
<p>In this situation, it may be desirable in some cases to have a resource with public methods, and a &ldquo;protected&rdquo; set of capabilities that are not accessible:</p>
<pre class="prettyprint"><code class="language-scala">trait ItemRepository {
  def name: String  // okay for anyone to access this!
  
  private[???] def deleter: Deleter // only accessible to authorized objects, if we knew what ??? was
}
</code></pre>
<p>There is a way to implement this! In Scala, only the public methods on an object are exposed &ndash; private methods cannot be referenced externally. We can use Scala&rsquo;s <a href="http://jesperdj.com/2016/01/08/scala-access-modifiers-and-qualifiers-in-detail/">access modifiers and qualifiers</a> to selectively expose capabilities. We&rsquo;ll demonstrate in this section.</p>
<p>So, say you have a class <code>Document</code>, with a private <code>Path</code> that contains the text of the document.</p>
<pre class="prettyprint"><code class="language-scala">import java.nio.file._
final class Document(private[this] val path: Path) {
    ...
}
</code></pre>
<p>We want to restrict access so that we can read from the document without exposing the path.</p>
<p>First, we create a companion object <code>Document</code> and add a <code>NameChanger</code> trait:</p>
<pre class="prettyprint"><code class="language-scala">object Document {
  trait Reader {
    def bufferedReader[T](block: BufferedReader =&gt; T): T
  }
}
</code></pre>
<p>Next, we create a private singleton object called <code>capabilities</code> and add a <code>reader</code> implementation:</p>
<pre class="prettyprint"><code class="language-scala">final class Document(private[this] val path: Path) {
  private object capabilities {
    val reader: Document.Reader = new Document.Reader {
      override def bufferedReader[T](block: BufferedReader =&gt; T): T = {
        val reader = Files.newBufferedReader(Document.this.path, StandardCharsets.UTF_8)
        try {
          block(reader)
        } finally {
          reader.close()
        }
      }
    }
  }
}
</code></pre>
<p>Finally, we add an <code>Access</code> class that can expose the <code>Reader</code> for a particular <code>Document</code> instance:</p>
<pre class="prettyprint"><code class="language-scala">object Document {
  final class Access private {
    def reader(doc: Document): Reader = doc.capabilities.reader
  }
  object Access {
    private val instance = new Access()
    def apply(): Access = instance
  }
}
</code></pre>
<p>In order to have a reference to a <code>reader</code>, you must have access to both a <code>Document.Access</code> instance and a <code>Document</code>:</p>
<pre class="prettyprint"><code class="language-scala">val path = Path.get(&quot;document.txt&quot;)
val document = new Document(path)
val access = Document.Access()
val reader = access.reader(document)
val text = reader.bufferedReader(_.readLine())
</code></pre>
<p>When you put two capabilities together to expose functionality that is more than the individual pieces, it is called <em>amplification</em>. Other useful examples of <em>amplification</em> are when a &ldquo;can&rdquo; and a &ldquo;can opener&rdquo; are put together, or a &ldquo;private key&rdquo; and &ldquo;document encrypted with public key.&rdquo;</p>
<p>Creating an <code>Access</code> class can also be useful because it can mediate between a resource and the capabilities on the resource, without directly involving the resource itself. For example, referring back to the effects section above, a <code>TryAccess</code> class may provide a <code>Try</code> effect on all the capabilities of the <code>Document</code>.</p>
<pre class="prettyprint"><code class="language-scala">final class TryAccess private {
  def reader(doc: Document): Reader[Try] = Try(doc.capabilities.reader)
}
</code></pre>
<p>Or you can go for a full-on type class approach:</p>
<pre class="prettyprint"><code class="language-scala">object Document {
  trait NameChanger[F[_]] {
    def changeName(name: String): F[Unit]
  }

  trait WithEffect[C[_[_]], F[_]] {
    def apply(capability: C[Id]): C[F]
  }

  // The default &quot;no effect&quot; type Id[A] = A
  implicit val idEffect: NameChanger WithEffect Id = new WithEffect[NameChanger, Id] {
    override def apply(capability: NameChanger[Id]): NameChanger[Id] = identity(capability)
  }

  // Apply a &quot;Try&quot; effect to the capability
  implicit val tryEffect: NameChanger WithEffect Try = new WithEffect[NameChanger, Try] {
    override def apply(capability: NameChanger[Id]): NameChanger[Try] = new NameChanger[Try] {
      override def changeName(name: String): Try[Unit] =  Try(capability.changeName(name))
    }
  }

  class Access {
    def nameChanger[F[_]](doc: Document)(implicit ev: NameChanger WithEffect F): NameChanger[F] = {
      val effect = implicitly[NameChanger WithEffect F]
      effect(doc.capabilities.nameChanger)
    }
  }
}

val idNameChanger = access.nameChanger[Id](document)
</code></pre>
<p>This <code>Access</code> class constructor is public here, but obviously anyone who has both <code>Access</code> and a resource will be able to expose capabilities, so you should protect your access appropriately. You can use dynamic sealing or Scala access modifiers to ensure access is tightly controlled.</p>
<p>Note that these are &ldquo;root level&rdquo; capabilities &ndash; they are non-revocable, &ldquo;private key&rdquo; object references, so you typically want to wrap these in <code>ocap.Revocable</code> and hand out the revocable capability (aka caretaker) instead.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/ocaps/tree/master/src/main/paradox/guide/construction.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../guide/authorization.html">Authorizing Capabilities</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../guide/construction.html#constructing-capabilities" class="header">Constructing Capabilities</a>
  <ul>
    <li><a href="../guide/construction.html#capabilities-as-traits" class="header">Capabilities as Traits</a></li>
    <li><a href="../guide/construction.html#construction-through-composition" class="header">Construction Through Composition</a></li>
    <li><a href="../guide/construction.html#effects-in-capabilities-with-tagless-final" class="header">Effects in Capabilities with Tagless Final</a></li>
    <li><a href="../guide/construction.html#construction-through-access" class="header">Construction Through Access</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2024</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0-SNAPSHOT', 'https://github.com/tersesystems/ocaps')});</script>


</html>
