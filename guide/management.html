<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Managing Capabilities · ocaps</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='ocaps'/>
<link rel="canonical" href="https://github.com/tersesystems/ocapsguide/management.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>ocaps
</a>
<div class="version-number">
1.0.0*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction/index.html" class="page">Construction</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/expiration.html" class="page">Expiration</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/abstraction.html" class="page">Abstraction</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
    <li><a href="../examples/horton.html" class="page">Responsibility Tracking (Horton)</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="active page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">ocaps</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>ocaps
</a>
<div class="version-number">
1.0.0*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../running.html" class="page">Running</a></li>
  <li><a href="../examples/index.html" class="page">Examples</a>
  <ul>
    <li><a href="../examples/construction/index.html" class="page">Construction</a></li>
    <li><a href="../examples/composition.html" class="page">Composition</a></li>
    <li><a href="../examples/attenuation.html" class="page">Attenuation</a></li>
    <li><a href="../examples/modulation.html" class="page">Modulation</a></li>
    <li><a href="../examples/revocation.html" class="page">Revocation</a></li>
    <li><a href="../examples/expiration.html" class="page">Expiration</a></li>
    <li><a href="../examples/amplification.html" class="page">Amplification</a></li>
    <li><a href="../examples/abstraction.html" class="page">Abstraction</a></li>
    <li><a href="../examples/delegation.html" class="page">Delegation</a></li>
    <li><a href="../examples/gatekeeper.html" class="page">Gatekeeper</a></li>
    <li><a href="../examples/dynamic_seal.html" class="page">Dynamic Sealing</a></li>
    <li><a href="../examples/membrane.html" class="page">Membrane</a></li>
    <li><a href="../examples/horton.html" class="page">Responsibility Tracking (Horton)</a></li>
  </ul></li>
  <li><a href="../guide/index.html" class="page">A Guide To Capabilities</a>
  <ul>
    <li><a href="../guide/introduction.html" class="page">Introducing Capabilities</a></li>
    <li><a href="../guide/construction.html" class="page">Constructing Capabilities</a></li>
    <li><a href="../guide/authorization.html" class="page">Authorizing Capabilities</a></li>
    <li><a href="../guide/management.html" class="active page">Managing Capabilities</a></li>
    <li><a href="../guide/confinement.html" class="page">Confining Capabilities</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">ocaps</a></li>
  <li><a href="../guide/index.html">A Guide To Capabilities</a></li>
  <li>Managing Capabilities</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#managing-capabilities" name="managing-capabilities" class="anchor"><span class="anchor-link"></span></a>Managing Capabilities</h1>
<p>Management of capabilities is based around the concepts of <em>revocation</em> and <em>modulation</em>: being able to stop a capability that has already been assigned, and being able to augment the behavior of capabilities for security purposes.</p>
<h3><a href="#managing-accessibility-with-revocation" name="managing-accessibility-with-revocation" class="anchor"><span class="anchor-link"></span></a>Managing Accessibility with Revocation</h3>
<p>This naturally brings up the question of how to limit access to an already granted capability, for example to limit the lifespan of a capability to the lifespan of a user session, so the capability is no longer valid after logout or timeout. This is done using <em>revocation</em>, but more importantly, this is done using a whole series of constructs based around <em>revocation</em>, the most important being the <code>Revocable</code> pattern, also known as the <a href="http://www.dtic.mil/docs/citations/ADA001721">Caretaker</a>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Please see the <a href="../examples/revocation.html">Revocation example</a> for a complete example.</p></div>
<p>We&rsquo;ve shown an example of <em>revocation</em> in the bakery above, but revocation as a concept is important enough that it has a specific trait associated with it &ndash; a <code>Revoker</code>:</p>
<pre class="prettyprint"><code class="language-scala">package ocaps

trait Revoker {
  def revoke(): Unit
}
</code></pre>
<p>A revoker does one thing &ndash; it revokes access to a proxied capability. When the <code>revoke</code> method is invoked, the proxy will no longer forward calls to the capability, and will instead throw a <code>RevokedException</code>.</p>
<p>Of course, a <code>Revoker</code> does no good without something to revoke.</p>
<p>The <code>Revocable</code> handles the creation of a revoker and associated proxy. The apply method of the <code>Revocable</code> is implemented as follows:</p>
<pre class="prettyprint"><code class="language-scala">package ocaps

object Revocable {
  def apply[C](capability: C)(cblock: (() =&gt; C) =&gt; C): Revocable[C] = {
    val (thunk, revoker) = Revoker.tuple(capability)
    val revocableCapability: C = cblock(thunk)
    Revocable(revocableCapability, revoker)
  }
}
</code></pre>
<p>The <code>cblock</code> of the Revocable is a constructor block &ndash; it passes in a capability thunk, and returns the proxy implementation.</p>
<pre class="prettyprint"><code class="language-scala">import ocaps._

trait Doer {
  def doTheThing(): Unit
}

object Doer {
  def revocable(doer: Doer): Revocable[Doer] = {
    Revocable(doer) { thunkedDoer =&gt;
      new Doer {
        override def doTheThing(): Unit = thunkedDoer().doTheThing()
      }
    }
  }
}
</code></pre>
<p>and will be used as follows:</p>
<pre class="prettyprint"><code class="language-scala">val Revocable(revocableDoer, revoker) = Doer.revocable(access.doer)
revocableDoer.doTheThing() // works fine
revoker.revoke()
revocableDoer.doTheThing() // throws exception!
</code></pre>
<p>You can also use the <code>revocable</code> macro, which will create the implementation proxy automatically:</p>
<pre class="prettyprint"><code class="language-scala">import ocaps._
import ocaps.macros._

// takes a `Doer` trait as a type parameter and autocreates implementation
val Revocable(revocableDoer, revoker) = revocable[Doer](access.doer)
</code></pre>
<p>If you have several revokers, you can compose them together using `Revoker.compose``:</p>
<pre class="prettyprint"><code class="language-scala">val revokerABC = Revoker.compose(revokerA, revokerB, revokerC)
revokerABC.revoke() // revoke A, B, and C all at the same time.
</code></pre>
<p>By using revokers, you can tie capabilities to the lifespan of a user session by revoking them on session close or timeout. Any call to the capability after revocation will result in failure. For this reason, revocation is sometimes called <a href="http://soft.vub.ac.be/events/mobicrant_talks/talk2_OO_security.pdf">temporal attenuation</a>.</p>
<p>Recovery from revocation is application specific. If an operation fails, the component that owns the capability may request a fresh new capability to replace the revoked one, or may require reauthorization or reauthentication before reinstantiation. Akka Actors work extremely well in this context, as does judicious use of the IO monad.</p>
<h3><a href="#managing-behavior-with-modulation" name="managing-behavior-with-modulation" class="anchor"><span class="anchor-link"></span></a>Managing Behavior with Modulation</h3>
<p>Modulation is an extremely powerful technique that wraps a capability in additional behavior. The canonical example of modulation is logging:</p>
<pre class="prettyprint"><code class="language-scala">def loggingDoer(doer: Foo.Doer, logger: Logger): Foo.Doer = {
  new Foo.Doer {
    override def doTheThing(): Int = {
      logger.info(s&quot;doTheThing: before call&quot;)
      val result = doer.doTheThing()
      logger.info(s&quot;doTheThing: after returns $result&quot;)
      result
    }
  }
}
</code></pre><div class="callout note "><div class="callout-title">Note</div>
<p>Please see <a href="../examples/modulation.html">modulation</a> for a complete example.</p></div>
<p>Modulation of a capability must obey behavioral subtyping &ndash; it is acceptable to throw an exception and fail in security related conditions, but it is not acceptable to add new functionality, because it violates the <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov substitution principle</a>. For example, the following is extremely rude:</p>
<pre class="prettyprint"><code class="language-scala">def badlyBehavedDoer(doer: Foo.Doer, logger: Logger): Foo.Doer = {
  new Foo.Doer {
    override def doTheThing(): Int = {
      val result = doer.doTheThing()
      if (result &gt; 0) -1 else result // NEVER DO THIS
    }
  }
}
</code></pre>
<p>Modulation can be used in a <a href="https://en.wikipedia.org/wiki/Design_by_contract">design by contract</a> style preconditions and postconditions. For example, given an <code>ItemRepository.Finder</code>, we can specify a finder which must match a particular id (often called <em>narrowing</em>):</p>
<pre class="prettyprint"><code class="language-scala">def idPreFinder(finder: ItemRepository.Finder, validIds: Set[UUID]): ItemRepository.Finder = {
  new ItemRepository.Finder {
    def find(id: UUID): Option[Item] = {
      if (validIds.contains(id)) {
        finder.find(id)
      } else {
        throw new CapabilityException(&quot;Invalid id!&quot;)
      }
    }
  }
}
</code></pre>
<p>Or modulation can verify a post condition exists &ndash; for example, ensuring that only items owned by a particular user can be found:</p>
<pre class="prettyprint"><code class="language-scala">def userPostFinder(finder: ItemRepository.Finder, user: User): ItemRepository.Finder = {
  new ItemRepository.Finder {
    def find(id: UUID): Option[Item] = {
      val result = finder.find(id)
      result.foreach { item =&gt;
         if (! item.owner.equals(user)) {
           throw new CapabilityException(&quot;Invalid id!&quot;)
         }
      }
      result
    }
  }
}
</code></pre>
<p>Using modulation with capabilities, additional security guarantees can be added transparently to operations.</p>
<p>To skip the boilerplate, there is a capability macro which can automate the implementation of modulation by providing <code>before</code> and <code>after</code> functions:</p>
<pre class="prettyprint"><code class="language-scala">import ocaps.macros._

def loggingDoer(doer: Foo.Doer, logger: Logger): Foo.Doer = {
  val before: String =&gt; Unit = methodName =&gt; {
    logger.info(s&quot;$methodName: before call&quot;)
  }
  val after: (String, Any) =&gt; Unit = (methodName, result) =&gt;
    logger.info(s&quot;$methodName: after returns $result&quot;)
  modulate[Foo.Doer](doer, before, after)
}
</code></pre>
<h3><a href="#managing-lifecycle-with-expiration" name="managing-lifecycle-with-expiration" class="anchor"><span class="anchor-link"></span></a>Managing Lifecycle with Expiration</h3>
<p>Expiration combines <em>modulation</em> of a capability with <em>revocation</em>. Using modulation, a capability can make use of internal or external state to decide whether it should revoke access through an internal revoker.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Please see <a href="../examples/expiration.html">Expiration example</a> for a complete example.</p></div>
<p>Expiration can be used to create a limited use capability, which is revoked after a certain number of calls.</p>
<pre class="prettyprint"><code class="language-scala">def countBasedExpiration(doer: Foo.Doer, count: Int): Foo.Doer = {
  val latch = new java.util.concurrent.atomic.AtomicInteger(1)
  val Revocable(revocableDoer, revoker) = revocable[Foo.Doer](doer)
  val before: (String, Any) =&gt; Unit = (_, _) =&gt;
   if (latch.getAndDecrement() == 0) {
     revoker.revoke()
   }
  modulate[Foo.Doer](revocableDoer, before, after)
} 
</code></pre>
<p>Count based expiration is especially useful when delegating a capability to an external worker which may execute at a much later date. If you recall the bakery that allows you to eat your cake once and only once, this is a generalization of the technique.</p>
<p>A capability can also limit access by only allowing access based on a timer:</p>
<pre class="prettyprint"><code class="language-scala">def timerBasedExpiration(doer: Foo.Doer, duration: FiniteDuration): Foo.Doer = {
  val deadline = duration.fromNow
  val Caretaker(revokerDoer, revoker) = caretaker[Foo.Doer](doer)
  val before: String =&gt; Unit = _ =&gt; if (deadline.isOverdue()) {
                                      revoker.revoke()
                                    }
  val after: (String, Any) =&gt; Unit = (_, _) =&gt; ()
  }
  modulate[Foo.Doer](revokerDoer, before, after)
}
</code></pre>
<p>Timer based expiration is helpful in resisting <a href="https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use">Time of Check/Time of Use</a> attacks and providing &ldquo;sudo&rdquo; mode for limited admin access. </p>
<p>Expiration can also depend on external behavior, such as a supervisor that may look for suspicious activity.</p>
<pre class="prettyprint"><code class="language-scala">def supervisorBasedExpiration(doer: Foo.Doer, supervisor: Supervisor): Foo.Doer = {
  val Revocable(revokerDoer, revoker) = revocable[Foo.Doer](doer)
  val before: String =&gt; Unit = _methodName =&gt; {
    if (! supervisor.accept(doer, methodName)) {
      revoker.revoke()
    }
  }
  val after: (String, Any) =&gt; Unit = (_, _) =&gt; ()
  modulate[Foo.Doer](revokerDoer, before, after)
}
</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/ocaps/tree/master/src/main/paradox/guide/management.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../guide/confinement.html">Confining Capabilities</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../guide/management.html#managing-capabilities" class="header">Managing Capabilities</a>
  <ul>
    <li><a href="../guide/management.html#managing-accessibility-with-revocation" class="header">Managing Accessibility with Revocation</a></li>
    <li><a href="../guide/management.html#managing-behavior-with-modulation" class="header">Managing Behavior with Modulation</a></li>
    <li><a href="../guide/management.html#managing-lifecycle-with-expiration" class="header">Managing Lifecycle with Expiration</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2024</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.0.0-SNAPSHOT', 'https://github.com/tersesystems/ocaps')});</script>


</html>
